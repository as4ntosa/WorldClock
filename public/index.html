<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World Clock</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f2f5;
      color: #1a1a2e;
    }

    .screen {
      display: none;
      text-align: center;
      padding: 2rem;
      width: 100%;
    }

    .screen.active {
      display: block;
    }

    /* ‚îÄ‚îÄ Form Screen ‚îÄ‚îÄ */
    #form-screen {
      max-width: 440px;
      margin: 0 auto;
    }

    .form-card {
      background: #fff;
      border-radius: 16px;
      padding: 2.5rem 2rem 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 8px 30px rgba(0,0,0,0.06);
    }

    .form-card h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: #1a1a2e;
      margin-bottom: 0.3rem;
    }

    .form-card .subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1.8rem;
    }

    #user-form {
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
    }

    #user-form label {
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    #user-form input {
      padding: 0.7rem 0.9rem;
      border: 1.5px solid #d1d5db;
      border-radius: 10px;
      background: #f9fafb;
      color: #1a1a2e;
      font-family: inherit;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #user-form input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
      background: #fff;
    }

    #user-form input::placeholder {
      color: #9ca3af;
    }

    #user-form button {
      margin-top: 0.4rem;
      padding: 0.75rem;
      border: none;
      border-radius: 10px;
      background: #4f46e5;
      color: #fff;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    #user-form button:hover {
      background: #4338ca;
    }

    #user-form button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    #error-msg {
      color: #dc2626;
      font-size: 0.85rem;
      min-height: 1.3em;
    }

    /* Mood selector */
    .mood-label {
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .mood-options {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }

    .mood-btn {
      flex: 1;
      padding: 0.6rem 0.4rem;
      border: 1.5px solid #d1d5db;
      border-radius: 10px;
      background: #f9fafb;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }

    .mood-btn:hover {
      border-color: #4f46e5;
      background: #eef2ff;
    }

    .mood-btn.selected {
      border-color: #4f46e5;
      background: #eef2ff;
      box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
    }

    .mood-btn .mood-emoji {
      font-size: 1.6rem;
      display: block;
    }

    .mood-btn .mood-text {
      font-size: 0.7rem;
      font-weight: 500;
      color: #6b7280;
      margin-top: 0.2rem;
    }

    /* Now Playing card */
    .now-playing {
      margin-top: 1rem;
      background: #fff;
      border-radius: 14px;
      padding: 1rem 1.2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      gap: 1rem;
      text-align: left;
    }

    .now-playing-icon {
      font-size: 2rem;
      line-height: 1;
      animation: pulse 1.5s ease infinite;
    }

    .now-playing-info {
      flex: 1;
    }

    .now-playing-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1a1a2e;
    }

    .now-playing-artist {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.1rem;
    }

    .now-playing-reason {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.3rem;
      line-height: 1.4;
      font-style: italic;
    }

    .now-playing-toggle {
      padding: 0.4rem 0.8rem;
      border: 1.5px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .now-playing-toggle:hover {
      border-color: #4f46e5;
    }

    #youtube-player {
      position: absolute;
      width: 1px;
      height: 1px;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }

    /* ‚îÄ‚îÄ Display Screen ‚îÄ‚îÄ */
    #display-screen {
      max-width: 900px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease;
    }

    .hero-card {
      background: linear-gradient(135deg, #4f46e5, #7c3aed);
      color: #fff;
      border-radius: 20px;
      padding: 2.5rem 2rem 2rem;
      box-shadow: 0 4px 20px rgba(79,70,229,0.25);
    }

    #greeting {
      font-size: 1.5rem;
      font-weight: 600;
      opacity: 0.95;
    }

    #city-label {
      font-size: 0.85rem;
      opacity: 0.7;
      margin-top: 0.3rem;
      margin-bottom: 1.5rem;
    }

    #clock {
      font-size: 4rem;
      font-weight: 300;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.03em;
      line-height: 1.1;
    }

    #date-label {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-top: 0.4rem;
    }

    /* ‚îÄ‚îÄ Info Cards Row ‚îÄ‚îÄ */
    .info-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
      margin-top: 1rem;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 1.2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
      text-align: left;
    }

    .card h2 {
      font-size: 0.7rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.8rem;
    }

    /* Weather card */
    #weather {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    #weather-icon {
      font-size: 2.2rem;
      line-height: 1;
    }

    #weather-details {
      flex: 1;
    }

    #weather-temp {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a1a2e;
    }

    #weather-desc {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.1rem;
    }

    #weather-extra {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.2rem;
    }

    .aqi-bar {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #f3f4f6;
    }

    .aqi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.35rem;
    }

    .aqi-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
    }

    .aqi-badge {
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.15rem 0.5rem;
      border-radius: 6px;
      color: #fff;
    }

    .aqi-track {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .aqi-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .aqi-details {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.3rem;
    }

    /* News card */
    .news-card {
      max-height: 220px;
      overflow-y: auto;
    }

    .news-card::-webkit-scrollbar {
      width: 4px;
    }
    .news-card::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }

    .news-item {
      padding: 0.55rem 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .news-item:last-child {
      border-bottom: none;
    }

    .news-item a {
      color: #1a1a2e;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 500;
      line-height: 1.4;
      display: block;
      transition: color 0.15s;
    }

    .news-item a:hover {
      color: #4f46e5;
    }

    .news-meta {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.15rem;
    }

    /* Restaurant card */
    .restaurant-card {
      max-height: 220px;
      overflow-y: auto;
    }

    .restaurant-card::-webkit-scrollbar {
      width: 4px;
    }
    .restaurant-card::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }

    .rest-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid #f3f4f6;
    }

    .rest-item:last-child {
      border-bottom: none;
    }

    .rest-name {
      font-size: 0.8rem;
      font-weight: 500;
      color: #1a1a2e;
    }

    .rest-cuisine {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.1rem;
    }

    /* Map */
    #map-container {
      margin-top: 1rem;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
    }

    #map {
      height: 300px;
      width: 100%;
    }

    /* Back button */
    #back-btn {
      margin-top: 1.5rem;
      padding: 0.55rem 1.6rem;
      border: 1.5px solid #d1d5db;
      border-radius: 10px;
      background: #fff;
      color: #6b7280;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    #back-btn:hover {
      border-color: #4f46e5;
      color: #4f46e5;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .info-row {
        grid-template-columns: 1fr;
      }
      #clock {
        font-size: 3rem;
      }
      .hero-card {
        padding: 2rem 1.5rem 1.5rem;
      }
    }
  </style>
</head>
<body>

  <!-- Form Screen -->
  <div id="form-screen" class="screen active">
    <div class="form-card">
      <h1>World Clock</h1>
      <p class="subtitle">Enter your details to see the local time, weather, and news.</p>
      <form id="user-form">
        <label for="name-input">Name</label>
        <input type="text" id="name-input" placeholder="e.g. Alexis" required autocomplete="off">
        <label for="city-input">City</label>
        <input type="text" id="city-input" placeholder="e.g. Tokyo" required autocomplete="off">
        <p class="mood-label">How are you feeling?</p>
        <div class="mood-options">
          <div class="mood-btn" data-mood="happy">
            <span class="mood-emoji">üòä</span>
            <span class="mood-text">Happy</span>
          </div>
          <div class="mood-btn" data-mood="sad">
            <span class="mood-emoji">üò¢</span>
            <span class="mood-text">Sad</span>
          </div>
          <div class="mood-btn" data-mood="angry">
            <span class="mood-emoji">üò†</span>
            <span class="mood-text">Angry</span>
          </div>
        </div>
        <button type="submit">Submit</button>
        <p id="error-msg"></p>
      </form>
    </div>
  </div>

  <!-- Display Screen -->
  <div id="display-screen" class="screen">
    <div class="hero-card">
      <p id="greeting"></p>
      <p id="city-label"></p>
      <p id="clock"></p>
      <p id="date-label"></p>
    </div>

    <div class="info-row">
      <div class="card" id="weather-card">
        <h2>Weather</h2>
        <div id="weather">
          <span id="weather-icon"></span>
          <div id="weather-details">
            <p id="weather-temp"></p>
            <p id="weather-desc"></p>
            <p id="weather-extra"></p>
          </div>
        </div>
        <div class="aqi-bar" id="aqi-section" style="display:none;">
          <div class="aqi-header">
            <span class="aqi-label">Air Quality Index</span>
            <span class="aqi-badge" id="aqi-badge"></span>
          </div>
          <div class="aqi-track">
            <div class="aqi-fill" id="aqi-fill"></div>
          </div>
          <p class="aqi-details" id="aqi-details"></p>
        </div>
      </div>
      <div class="card news-card" id="news">
        <h2>Local News</h2>
      </div>
      <div class="card restaurant-card" id="restaurants">
        <h2>Nearby Restaurants</h2>
      </div>
    </div>

    <div class="now-playing" id="now-playing" style="display:none;">
      <span class="now-playing-icon" id="np-icon">üéµ</span>
      <div class="now-playing-info">
        <p class="now-playing-title" id="np-title"></p>
        <p class="now-playing-artist" id="np-artist"></p>
        <p class="now-playing-reason" id="np-reason"></p>
      </div>
      <button class="now-playing-toggle" id="np-toggle">‚è∏Ô∏è</button>
    </div>
    <div id="youtube-player"></div>

    <div id="map-container">
      <div id="map"></div>
    </div>

    <button id="back-btn" data-default="Back">Back</button>
  </div>

  <script>
    const form = document.getElementById('user-form');
    const errorMsg = document.getElementById('error-msg');
    const formScreen = document.getElementById('form-screen');
    const displayScreen = document.getElementById('display-screen');

    let tickInterval = null;
    let mapInstance = null;
    let selectedMood = null;
    let ytPlayer = null;
    let isPlaying = false;

    // Mood selector
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedMood = btn.dataset.mood;
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';

      const name = document.getElementById('name-input').value.trim();
      const city = document.getElementById('city-input').value.trim();
      if (!name || !city) return;

      const btn = form.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Loading...';

      try {
        if (!selectedMood) throw new Error('Please select a mood.');

        const params = new URLSearchParams({ city, mood: selectedMood });
        const res = await fetch(`/api/lookup?${params}`);
        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        const tz = data.timeZone || estimateTimezone(data.lon);
        showDisplay(name, data.displayName, tz, data.lat, data.lon, data.weather, data.airQuality, data.news, data.restaurants, data.song, data.lang || 'en', data.locale || 'en-US');
      } catch (err) {
        errorMsg.textContent = err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Submit';
      }
    });

    const WMO_WEATHER = {
      0: ['Clear sky', '‚òÄÔ∏è'],
      1: ['Mainly clear', 'üå§Ô∏è'], 2: ['Partly cloudy', '‚õÖ'], 3: ['Overcast', '‚òÅÔ∏è'],
      45: ['Foggy', 'üå´Ô∏è'], 48: ['Icy fog', 'üå´Ô∏è'],
      51: ['Light drizzle', 'üå¶Ô∏è'], 53: ['Drizzle', 'üå¶Ô∏è'], 55: ['Heavy drizzle', 'üåßÔ∏è'],
      61: ['Light rain', 'üå¶Ô∏è'], 63: ['Rain', 'üåßÔ∏è'], 65: ['Heavy rain', 'üåßÔ∏è'],
      66: ['Freezing rain', 'üå®Ô∏è'], 67: ['Heavy freezing rain', 'üå®Ô∏è'],
      71: ['Light snow', 'üå®Ô∏è'], 73: ['Snow', '‚ùÑÔ∏è'], 75: ['Heavy snow', '‚ùÑÔ∏è'],
      77: ['Snow grains', '‚ùÑÔ∏è'],
      80: ['Light showers', 'üå¶Ô∏è'], 81: ['Showers', 'üåßÔ∏è'], 82: ['Heavy showers', 'üåßÔ∏è'],
      85: ['Light snow showers', 'üå®Ô∏è'], 86: ['Snow showers', '‚ùÑÔ∏è'],
      95: ['Thunderstorm', '‚õàÔ∏è'], 96: ['Thunderstorm w/ hail', '‚õàÔ∏è'], 99: ['Severe thunderstorm', '‚õàÔ∏è'],
    };

    const TRANSLATIONS = {
      en: { morning: 'Good morning', afternoon: 'Good afternoon', evening: 'Good evening', weather: 'Weather', news: 'Local News', restaurants: 'Nearby Restaurants', aqi: 'Air Quality Index', back: 'Back', noNews: 'No news found.', noRestaurants: 'No restaurants found.', nowPlaying: 'Now Playing' },
      es: { morning: 'Buenos d√≠as', afternoon: 'Buenas tardes', evening: 'Buenas noches', weather: 'Clima', news: 'Noticias Locales', restaurants: 'Restaurantes Cercanos', aqi: '√çndice de Calidad del Aire', back: 'Volver', noNews: 'No se encontraron noticias.', noRestaurants: 'No se encontraron restaurantes.', nowPlaying: 'Reproduciendo' },
      fr: { morning: 'Bonjour', afternoon: 'Bon apr√®s-midi', evening: 'Bonsoir', weather: 'M√©t√©o', news: 'Actualit√©s Locales', restaurants: 'Restaurants √† Proximit√©', aqi: 'Indice de Qualit√© de l\'Air', back: 'Retour', noNews: 'Aucune actualit√© trouv√©e.', noRestaurants: 'Aucun restaurant trouv√©.', nowPlaying: 'En Lecture' },
      de: { morning: 'Guten Morgen', afternoon: 'Guten Tag', evening: 'Guten Abend', weather: 'Wetter', news: 'Lokale Nachrichten', restaurants: 'Restaurants in der N√§he', aqi: 'Luftqualit√§tsindex', back: 'Zur√ºck', noNews: 'Keine Nachrichten gefunden.', noRestaurants: 'Keine Restaurants gefunden.', nowPlaying: 'Wird Gespielt' },
      it: { morning: 'Buongiorno', afternoon: 'Buon pomeriggio', evening: 'Buonasera', weather: 'Meteo', news: 'Notizie Locali', restaurants: 'Ristoranti Vicini', aqi: 'Indice di Qualit√† dell\'Aria', back: 'Indietro', noNews: 'Nessuna notizia trovata.', noRestaurants: 'Nessun ristorante trovato.', nowPlaying: 'In Riproduzione' },
      pt: { morning: 'Bom dia', afternoon: 'Boa tarde', evening: 'Boa noite', weather: 'Clima', news: 'Not√≠cias Locais', restaurants: 'Restaurantes Pr√≥ximos', aqi: '√çndice de Qualidade do Ar', back: 'Voltar', noNews: 'Nenhuma not√≠cia encontrada.', noRestaurants: 'Nenhum restaurante encontrado.', nowPlaying: 'Tocando Agora' },
      ja: { morning: '„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô', afternoon: '„Åì„Çì„Å´„Å°„ÅØ', evening: '„Åì„Çì„Å∞„Çì„ÅØ', weather: 'Â§©Ê∞ó', news: 'Âú∞Âüü„Éã„É•„Éº„Çπ', restaurants: 'Ëøë„Åè„ÅÆ„É¨„Çπ„Éà„É©„É≥', aqi: 'Â§ßÊ∞óË≥™ÊåáÊï∞', back: 'Êàª„Çã', noNews: '„Éã„É•„Éº„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', noRestaurants: '„É¨„Çπ„Éà„É©„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', nowPlaying: 'ÂÜçÁîü‰∏≠' },
      ko: { morning: 'Ï¢ãÏùÄ ÏïÑÏπ®Ïù¥ÏóêÏöî', afternoon: 'Ï¢ãÏùÄ Ïò§ÌõÑÏòàÏöî', evening: 'Ï¢ãÏùÄ Ï†ÄÎÖÅÏù¥ÏóêÏöî', weather: 'ÎÇ†Ïî®', news: 'ÏßÄÏó≠ Îâ¥Ïä§', restaurants: 'Í∑ºÏ≤ò Î†àÏä§ÌÜ†Îûë', aqi: 'ÎåÄÍ∏∞Ïßà ÏßÄÏàò', back: 'Îí§Î°ú', noNews: 'Îâ¥Ïä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', noRestaurants: 'Î†àÏä§ÌÜ†ÎûëÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', nowPlaying: 'Ïû¨ÏÉù Ï§ë' },
      zh: { morning: 'Êó©‰∏äÂ•Ω', afternoon: '‰∏ãÂçàÂ•Ω', evening: 'Êôö‰∏äÂ•Ω', weather: 'Â§©Ê∞î', news: 'Êú¨Âú∞Êñ∞Èóª', restaurants: 'ÈôÑËøëÈ§êÂéÖ', aqi: 'Á©∫Ê∞îË¥®ÈáèÊåáÊï∞', back: 'ËøîÂõû', noNews: 'Êú™ÊâæÂà∞Êñ∞Èóª„ÄÇ', noRestaurants: 'Êú™ÊâæÂà∞È§êÂéÖ„ÄÇ', nowPlaying: 'Ê≠£Âú®Êí≠Êîæ' },
      ru: { morning: '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ', afternoon: '–î–æ–±—Ä—ã–π –¥–µ–Ω—å', evening: '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä', weather: '–ü–æ–≥–æ–¥–∞', news: '–ú–µ—Å—Ç–Ω—ã–µ –ù–æ–≤–æ—Å—Ç–∏', restaurants: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –ü–æ–±–ª–∏–∑–æ—Å—Ç–∏', aqi: '–ò–Ω–¥–µ–∫—Å –ö–∞—á–µ—Å—Ç–≤–∞ –í–æ–∑–¥—É—Ö–∞', back: '–ù–∞–∑–∞–¥', noNews: '–ù–æ–≤–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.', noRestaurants: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.', nowPlaying: '–°–µ–π—á–∞—Å –ò–≥—Ä–∞–µ—Ç' },
      hi: { morning: '‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§', afternoon: '‡§®‡§Æ‡§∏‡•ç‡§§‡•á', evening: '‡§∂‡•Å‡§≠ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ', weather: '‡§Æ‡•å‡§∏‡§Æ', news: '‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞', restaurants: '‡§Ü‡§∏-‡§™‡§æ‡§∏ ‡§ï‡•á ‡§∞‡•á‡§∏‡•ç‡§§‡§∞‡§æ‡§Ç', aqi: '‡§µ‡§æ‡§Ø‡•Å ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï', back: '‡§µ‡§æ‡§™‡§∏', noNews: '‡§ï‡•ã‡§à ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', noRestaurants: '‡§ï‡•ã‡§à ‡§∞‡•á‡§∏‡•ç‡§§‡§∞‡§æ‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§', nowPlaying: '‡§Ö‡§≠‡•Ä ‡§¨‡§ú ‡§∞‡§π‡§æ ‡§π‡•à' },
      ar: { morning: 'ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ±', afternoon: 'ŸÖÿ≥ÿßÿ° ÿßŸÑÿÆŸäÿ±', evening: 'ŸÖÿ≥ÿßÿ° ÿßŸÑÿÆŸäÿ±', weather: 'ÿßŸÑÿ∑ŸÇÿ≥', news: 'ÿ£ÿÆÿ®ÿßÿ± ŸÖÿ≠ŸÑŸäÿ©', restaurants: 'ŸÖÿ∑ÿßÿπŸÖ ŸÇÿ±Ÿäÿ®ÿ©', aqi: 'ŸÖÿ§ÿ¥ÿ± ÿ¨ŸàÿØÿ© ÿßŸÑŸáŸàÿßÿ°', back: 'ÿ±ÿ¨Ÿàÿπ', noNews: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£ÿÆÿ®ÿßÿ±.', noRestaurants: 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿ∑ÿßÿπŸÖ.', nowPlaying: 'Ÿäÿ™ŸÖ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ' },
      nl: { morning: 'Goedemorgen', afternoon: 'Goedemiddag', evening: 'Goedenavond', weather: 'Weer', news: 'Lokaal Nieuws', restaurants: 'Restaurants in de Buurt', aqi: 'Luchtkwaliteitsindex', back: 'Terug', noNews: 'Geen nieuws gevonden.', noRestaurants: 'Geen restaurants gevonden.', nowPlaying: 'Nu Speelt' },
      sv: { morning: 'God morgon', afternoon: 'God eftermiddag', evening: 'God kv√§ll', weather: 'V√§der', news: 'Lokala Nyheter', restaurants: 'Restauranger i N√§rheten', aqi: 'Luftkvalitetsindex', back: 'Tillbaka', noNews: 'Inga nyheter hittades.', noRestaurants: 'Inga restauranger hittades.', nowPlaying: 'Spelar Nu' },
      pl: { morning: 'Dzie≈Ñ dobry', afternoon: 'Dzie≈Ñ dobry', evening: 'Dobry wiecz√≥r', weather: 'Pogoda', news: 'Wiadomo≈õci Lokalne', restaurants: 'Restauracje w Pobli≈ºu', aqi: 'Indeks Jako≈õci Powietrza', back: 'Wr√≥ƒá', noNews: 'Nie znaleziono wiadomo≈õci.', noRestaurants: 'Nie znaleziono restauracji.', nowPlaying: 'Teraz Gra' },
      tr: { morning: 'G√ºnaydƒ±n', afternoon: 'ƒ∞yi g√ºnler', evening: 'ƒ∞yi ak≈üamlar', weather: 'Hava Durumu', news: 'Yerel Haberler', restaurants: 'Yakƒ±ndaki Restoranlar', aqi: 'Hava Kalitesi ƒ∞ndeksi', back: 'Geri', noNews: 'Haber bulunamadƒ±.', noRestaurants: 'Restoran bulunamadƒ±.', nowPlaying: '≈ûimdi √áalƒ±yor' },
      th: { morning: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤', afternoon: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢', evening: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡πÄ‡∏¢‡πá‡∏ô', weather: '‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', news: '‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô', restaurants: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á', aqi: '‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', back: '‡∏Å‡∏•‡∏±‡∏ö', noNews: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πà‡∏≤‡∏ß', noRestaurants: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', nowPlaying: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô' },
      vi: { morning: 'Ch√†o bu·ªïi s√°ng', afternoon: 'Ch√†o bu·ªïi chi·ªÅu', evening: 'Ch√†o bu·ªïi t·ªëi', weather: 'Th·ªùi ti·∫øt', news: 'Tin ƒê·ªãa Ph∆∞∆°ng', restaurants: 'Nh√† H√†ng G·∫ßn ƒê√¢y', aqi: 'Ch·ªâ S·ªë Ch·∫•t L∆∞·ª£ng Kh√¥ng Kh√≠', back: 'Quay l·∫°i', noNews: 'Kh√¥ng t√¨m th·∫•y tin t·ª©c.', noRestaurants: 'Kh√¥ng t√¨m th·∫•y nh√† h√†ng.', nowPlaying: 'ƒêang Ph√°t' },
      id: { morning: 'Selamat pagi', afternoon: 'Selamat siang', evening: 'Selamat malam', weather: 'Cuaca', news: 'Berita Lokal', restaurants: 'Restoran Terdekat', aqi: 'Indeks Kualitas Udara', back: 'Kembali', noNews: 'Berita tidak ditemukan.', noRestaurants: 'Restoran tidak ditemukan.', nowPlaying: 'Sedang Diputar' },
      el: { morning: 'ŒöŒ±ŒªŒ∑ŒºŒ≠œÅŒ±', afternoon: 'ŒöŒ±Œªœå Œ±œÄœåŒ≥ŒµœÖŒºŒ±', evening: 'ŒöŒ±ŒªŒ∑œÉœÄŒ≠œÅŒ±', weather: 'ŒöŒ±ŒπœÅœåœÇ', news: 'Œ§ŒøœÄŒπŒ∫Œ¨ ŒùŒ≠Œ±', restaurants: 'ŒöŒøŒΩœÑŒπŒΩŒ¨ ŒïœÉœÑŒπŒ±œÑœåœÅŒπŒ±', aqi: 'ŒîŒµŒØŒ∫œÑŒ∑œÇ Œ†ŒøŒπœåœÑŒ∑œÑŒ±œÇ ŒëŒ≠œÅŒ±', back: 'Œ†ŒØœÉœâ', noNews: 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ ŒΩŒ≠Œ±.', noRestaurants: 'ŒîŒµŒΩ Œ≤œÅŒ≠Œ∏Œ∑Œ∫Œ±ŒΩ ŒµœÉœÑŒπŒ±œÑœåœÅŒπŒ±.', nowPlaying: 'Œ†Œ±ŒØŒ∂ŒµŒπ Œ§œéœÅŒ±' },
      he: { morning: '◊ë◊ï◊ß◊® ◊ò◊ï◊ë', afternoon: '◊¶◊î◊®◊ô◊ô◊ù ◊ò◊ï◊ë◊ô◊ù', evening: '◊¢◊®◊ë ◊ò◊ï◊ë', weather: '◊û◊ñ◊í ◊ê◊ï◊ï◊ô◊®', news: '◊ó◊ì◊©◊ï◊™ ◊û◊ß◊ï◊û◊ô◊ï◊™', restaurants: '◊û◊°◊¢◊ì◊ï◊™ ◊ë◊°◊ë◊ô◊ë◊î', aqi: '◊û◊ì◊ì ◊ê◊ô◊õ◊ï◊™ ◊ê◊ï◊ï◊ô◊®', back: '◊ó◊ñ◊®◊î', noNews: '◊ú◊ê ◊†◊û◊¶◊ê◊ï ◊ó◊ì◊©◊ï◊™.', noRestaurants: '◊ú◊ê ◊†◊û◊¶◊ê◊ï ◊û◊°◊¢◊ì◊ï◊™.', nowPlaying: '◊û◊™◊†◊í◊ü ◊õ◊¢◊™' },
      uk: { morning: '–î–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É', afternoon: '–î–æ–±—Ä–∏–π –¥–µ–Ω—å', evening: '–î–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä', weather: '–ü–æ–≥–æ–¥–∞', news: '–ú—ñ—Å—Ü–µ–≤—ñ –ù–æ–≤–∏–Ω–∏', restaurants: '–†–µ—Å—Ç–æ—Ä–∞–Ω–∏ –ü–æ–±–ª–∏–∑—É', aqi: '–Ü–Ω–¥–µ–∫—Å –Ø–∫–æ—Å—Ç—ñ –ü–æ–≤—ñ—Ç—Ä—è', back: '–ù–∞–∑–∞–¥', noNews: '–ù–æ–≤–∏–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.', noRestaurants: '–†–µ—Å—Ç–æ—Ä–∞–Ω—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.', nowPlaying: '–ó–∞—Ä–∞–∑ –ì—Ä–∞—î' },
      da: { morning: 'Godmorgen', afternoon: 'God eftermiddag', evening: 'Godaften', weather: 'Vejr', news: 'Lokale Nyheder', restaurants: 'Restauranter i N√¶rheden', aqi: 'Luftkvalitetsindeks', back: 'Tilbage', noNews: 'Ingen nyheder fundet.', noRestaurants: 'Ingen restauranter fundet.', nowPlaying: 'Spiller Nu' },
      fi: { morning: 'Hyv√§√§ huomenta', afternoon: 'Hyv√§√§ iltap√§iv√§√§', evening: 'Hyv√§√§ iltaa', weather: 'S√§√§', news: 'Paikalliset Uutiset', restaurants: 'L√§heiset Ravintolat', aqi: 'Ilmanlaatu¬≠indeksi', back: 'Takaisin', noNews: 'Uutisia ei l√∂ytynyt.', noRestaurants: 'Ravintoloita ei l√∂ytynyt.', nowPlaying: 'Nyt Soi' },
      no: { morning: 'God morgen', afternoon: 'God ettermiddag', evening: 'God kveld', weather: 'V√¶r', news: 'Lokale Nyheter', restaurants: 'Restauranter i N√¶rheten', aqi: 'Luftkvalitetsindeks', back: 'Tilbake', noNews: 'Ingen nyheter funnet.', noRestaurants: 'Ingen restauranter funnet.', nowPlaying: 'Spiller N√•' },
      ro: { morning: 'BunƒÉ diminea»õa', afternoon: 'BunƒÉ ziua', evening: 'BunƒÉ seara', weather: 'Vreme', news: '»òtiri Locale', restaurants: 'Restaurante Apropiate', aqi: 'Indicele CalitƒÉ»õii Aerului', back: '√énapoi', noNews: 'Nu s-au gƒÉsit »ôtiri.', noRestaurants: 'Nu s-au gƒÉsit restaurante.', nowPlaying: 'Se RedƒÉ Acum' },
      cs: { morning: 'Dobr√© r√°no', afternoon: 'Dobr√© odpoledne', evening: 'Dobr√Ω veƒçer', weather: 'Poƒças√≠', news: 'M√≠stn√≠ Zpr√°vy', restaurants: 'Restaurace v Okol√≠', aqi: 'Index Kvality Ovzdu≈°√≠', back: 'Zpƒõt', noNews: '≈Ω√°dn√© zpr√°vy nenalezeny.', noRestaurants: '≈Ω√°dn√© restaurace nenalezeny.', nowPlaying: 'Pr√°vƒõ Hraje' },
      tl: { morning: 'Magandang umaga', afternoon: 'Magandang hapon', evening: 'Magandang gabi', weather: 'Panahon', news: 'Lokal na Balita', restaurants: 'Mga Kalapit na Restaurant', aqi: 'Index ng Kalidad ng Hangin', back: 'Bumalik', noNews: 'Walang nahanap na balita.', noRestaurants: 'Walang nahanap na restaurant.', nowPlaying: 'Nagpe-play Ngayon' },
    };

    function t(lang, key) {
      return (TRANSLATIONS[lang] && TRANSLATIONS[lang][key]) || TRANSLATIONS.en[key];
    }

    function estimateTimezone(lon) {
      // Map longitude to a UTC offset timezone as a fallback
      const offset = Math.round(lon / 15);
      const sign = offset >= 0 ? '+' : '-';
      const abs = Math.abs(offset).toString().padStart(2, '0');
      return `Etc/GMT${offset <= 0 ? '+' : '-'}${Math.abs(offset)}`;
    }

    function timeAgo(date) {
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function getAqiInfo(aqi) {
      if (aqi <= 50) return { label: 'Good', color: '#22c55e' };
      if (aqi <= 100) return { label: 'Moderate', color: '#eab308' };
      if (aqi <= 150) return { label: 'Unhealthy (SG)', color: '#f97316' };
      if (aqi <= 200) return { label: 'Unhealthy', color: '#ef4444' };
      if (aqi <= 300) return { label: 'Very Unhealthy', color: '#a855f7' };
      return { label: 'Hazardous', color: '#7f1d1d' };
    }

    function showDisplay(name, displayName, timeZone, lat, lon, weather, airQuality, news, restaurants, song, lang, locale) {
      formScreen.classList.remove('active');
      displayScreen.classList.add('active');

      document.getElementById('city-label').textContent = displayName;

      // Render news
      const newsEl = document.getElementById('news');
      if (news && news.length) {
        const heading = `<h2>${t(lang, 'news')}</h2>`;
        const items = news.map(n => {
          const ago = n.pubDate ? timeAgo(new Date(n.pubDate)) : '';
          const source = n.source ? n.source : '';
          const meta = [source, ago].filter(Boolean).join(' ¬∑ ');
          const safeTitle = n.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `<div class="news-item">
            <a href="${n.link}" target="_blank" rel="noopener">${safeTitle}</a>
            ${meta ? `<div class="news-meta">${meta}</div>` : ''}
          </div>`;
        }).join('');
        newsEl.innerHTML = heading + items;
      } else {
        newsEl.innerHTML = `<h2>${t(lang, 'news')}</h2><p style="font-size:0.85rem;color:#9ca3af;">${t(lang, 'noNews')}</p>`;
      }

      // Render weather
      document.querySelector('#weather-card h2').textContent = t(lang, 'weather');
      if (weather) {
        const [desc, icon] = WMO_WEATHER[weather.weather_code] || ['Unknown', 'üå°Ô∏è'];
        document.getElementById('weather-icon').textContent = icon;
        document.getElementById('weather-temp').textContent = `${Math.round(weather.temperature_2m)}¬∞F`;
        document.getElementById('weather-desc').textContent = desc;
        document.getElementById('weather-extra').textContent =
          `Humidity ${weather.relative_humidity_2m}%  ¬∑  Wind ${Math.round(weather.wind_speed_10m)} mph`;
      }

      // Render AQI
      const aqiSection = document.getElementById('aqi-section');
      if (airQuality && airQuality.us_aqi != null) {
        const aqi = airQuality.us_aqi;
        const { label, color } = getAqiInfo(aqi);
        const pct = Math.min((aqi / 500) * 100, 100);

        document.querySelector('.aqi-label').textContent = t(lang, 'aqi');
        const badge = document.getElementById('aqi-badge');
        badge.textContent = `${aqi} ¬∑ ${label}`;
        badge.style.background = color;

        const fill = document.getElementById('aqi-fill');
        fill.style.width = `${pct}%`;
        fill.style.background = color;

        const details = document.getElementById('aqi-details');
        const parts = [];
        if (airQuality.pm2_5 != null) parts.push(`PM2.5: ${airQuality.pm2_5} \u03bcg/m\u00b3`);
        if (airQuality.pm10 != null) parts.push(`PM10: ${airQuality.pm10} \u03bcg/m\u00b3`);
        details.textContent = parts.join('  ¬∑  ');

        aqiSection.style.display = 'block';
      } else {
        aqiSection.style.display = 'none';
      }

      // Render restaurants list
      const restEl = document.getElementById('restaurants');
      if (restaurants && restaurants.length) {
        const heading = `<h2>${t(lang, 'restaurants')}</h2>`;
        const items = restaurants.map(r => {
          const cuisine = r.cuisine ? r.cuisine.replace(/;/g, ', ') : '';
          return `<div class="rest-item">
            <div class="rest-name">${r.name.replace(/</g, '&lt;')}</div>
            ${cuisine ? `<div class="rest-cuisine">${cuisine}</div>` : ''}
          </div>`;
        }).join('');
        restEl.innerHTML = heading + items;
      } else {
        restEl.innerHTML = `<h2>${t(lang, 'restaurants')}</h2><p style="font-size:0.85rem;color:#9ca3af;">${t(lang, 'noRestaurants')}</p>`;
      }

      // Update back button text
      document.getElementById('back-btn').textContent = t(lang, 'back');

      // Render now playing
      const npEl = document.getElementById('now-playing');
      const ytEl = document.getElementById('youtube-player');
      if (song) {
        document.getElementById('np-title').textContent = song.title;
        document.getElementById('np-artist').textContent = song.artist;
        document.getElementById('np-reason').textContent = song.reason;
        npEl.style.display = 'flex';

        // Embed YouTube iframe for audio playback
        ytEl.innerHTML = `<iframe id="yt-iframe" width="1" height="1" src="https://www.youtube.com/embed/${song.youtubeId}?autoplay=1&enablejsapi=1&loop=1&playlist=${song.youtubeId}" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;
        isPlaying = true;
        document.getElementById('np-toggle').textContent = '‚è∏Ô∏è';
        document.getElementById('np-icon').style.animationPlayState = 'running';
      } else {
        npEl.style.display = 'none';
        ytEl.innerHTML = '';
      }

      // Render map
      if (mapInstance) {
        mapInstance.remove();
        mapInstance = null;
      }
      setTimeout(() => {
        mapInstance = L.map('map').setView([lat, lon], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(mapInstance);

        // City center marker
        L.marker([lat, lon])
          .addTo(mapInstance)
          .bindPopup(`<strong>${displayName.split(',')[0]}</strong>`)
          .openPopup();

        // Restaurant markers
        if (restaurants && restaurants.length) {
          const restIcon = L.divIcon({
            html: '<div style="font-size:1.4rem;">üçΩÔ∏è</div>',
            className: '',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });
          restaurants.forEach(r => {
            const cuisine = r.cuisine ? ` (${r.cuisine.replace(/;/g, ', ')})` : '';
            L.marker([r.lat, r.lon], { icon: restIcon })
              .addTo(mapInstance)
              .bindPopup(`<strong>${r.name}</strong>${cuisine}`);
          });
        }
      }, 100);

      function tick() {
        const now = new Date();
        const options = { timeZone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: locale.startsWith('en') };
        const timeStr = now.toLocaleTimeString(locale, options);

        const hourOptions = { timeZone, hour: 'numeric', hour12: false };
        const hour = parseInt(now.toLocaleTimeString('en-US', hourOptions), 10);

        let period;
        if (hour >= 5 && hour < 12) period = 'morning';
        else if (hour >= 12 && hour < 18) period = 'afternoon';
        else period = 'evening';

        document.getElementById('greeting').textContent = `${t(lang, period)}, ${name}!`;
        document.getElementById('clock').textContent = timeStr;

        const dateOptions = { timeZone, weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('date-label').textContent = now.toLocaleDateString(locale, dateOptions);
      }

      tick();
      tickInterval = setInterval(tick, 1000);
    }

    // Play/pause toggle
    document.getElementById('np-toggle').addEventListener('click', () => {
      const iframe = document.getElementById('yt-iframe');
      if (!iframe) return;
      if (isPlaying) {
        iframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        document.getElementById('np-toggle').textContent = '‚ñ∂Ô∏è';
        document.getElementById('np-icon').style.animationPlayState = 'paused';
      } else {
        iframe.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*');
        document.getElementById('np-toggle').textContent = '‚è∏Ô∏è';
        document.getElementById('np-icon').style.animationPlayState = 'running';
      }
      isPlaying = !isPlaying;
    });

    document.getElementById('back-btn').addEventListener('click', () => {
      clearInterval(tickInterval);
      if (mapInstance) { mapInstance.remove(); mapInstance = null; }
      document.getElementById('youtube-player').innerHTML = '';
      document.getElementById('now-playing').style.display = 'none';
      selectedMood = null;
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
      displayScreen.classList.remove('active');
      formScreen.classList.add('active');
    });
  </script>

</body>
</html>
